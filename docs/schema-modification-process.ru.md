# Процесс модификации схемы

Этот документ описывает правильный процесс модификации схемы базы данных в приложении Tactris, включая то, как файл `schema.sql` вписывается в общий рабочий процесс.

## Понимание файлов схемы

### schema.sql
Файл `schema.sql` - это **справочный дамп** текущей структуры базы данных. Он содержит:
- Полное определение схемы всех таблиц, представлений, функций и т.д.
- Структуру базы данных на определенный момент времени
- Снимок, который можно использовать для повторного создания базы данных с нуля

**Важно**: Этот файл НЕ должен изменяться напрямую для внесения изменений схемы в развернутых средах.

### Файлы миграций
Файлы миграций в каталоге `migrations/` используются для:
- Применения пошаговых изменений к базе данных
- Отслеживания примененных изменений
- Поддержания целостности данных во время эволюции схемы
- Поддержки откатов при необходимости

## Правильный процесс изменения схемы

### 1. Когда вам нужно внести изменение схемы

Вместо прямого изменения `schema.sql`, следуйте этим шагам:

#### Шаг 1: Анализ изменения
- Определите, какие объекты базы данных нужно добавить, изменить или удалить
- Подумайте о влиянии на существующие данные
- Спланируйте обратную совместимость при необходимости

#### Шаг 2: Создание миграции
- Создайте новый файл миграции в каталоге `migrations/`
- Назовите его по формату: `YYYYMMDDHHMMSS_описание.sql`
- Напишите SQL-команды для внесения изменений
- Включите запись в таблицу миграций

#### Шаг 3: Обновление справочной схемы (опционально)
- После применения миграций вы можете захотеть обновить `schema.sql`
- Обычно это делается путем экспорта текущей структуры базы данных
- Этот шаг主要用于 документации и настройки разработки

### 2. Пример: Добавление нового столбца

#### ❌ Неправильный подход
Прямое редактирование `schema.sql`:
```sql
-- Это НЕПРАВИЛЬНО - не делайте этого для развернутых баз данных
ALTER TABLE users ADD COLUMN new_column TEXT;
```

#### ✅ Правильный подход
1. Создайте файл миграции `migrations/20251128153000_add_new_column.sql`:
```sql
-- Добавить new_column в таблицу users
ALTER TABLE users ADD COLUMN new_column TEXT DEFAULT 'default_value';
COMMENT ON COLUMN users.new_column IS 'Описание нового столбца';

-- Записать эту миграцию
INSERT INTO migrations (name) VALUES ('20251128153000_add_new_column.sql');
```

2. Запустите миграцию:
```bash
npm run migrate
```

### 3. Обновление schema.sql (Для справки)

После применения миграций, если вы хотите обновить справочную схему:

```bash
# Подключитесь к вашей базе данных и экспортируйте текущую схему
pg_dump --schema-only --no-owner --no-privileges -U username -d database_name > schema.sql
```

**Примечание**: Экспортированная схема не будет включать данные таблицы миграций, поэтому вам может понадобиться добавить их вручную или запустить миграции на новой базе данных.

## Рабочий процесс разработки

### Для новой разработки
1. Планируйте изменения схемы
2. Создавайте файлы миграций для каждого изменения
3. Применяйте миграции к базе данных разработки
4. Тестируйте ваше приложение с новой схемой
5. Зафиксируйте как файлы миграций, так и любой обновленный код приложения

### Для сброса базы данных в разработке
Если вам нужно сбросить базу данных разработки до справочной схемы:

1. Удалите и создайте заново базу данных:
```bash
dropdb tactris
createdb tactris
```

2. Импортируйте справочную схему:
```bash
psql -d tactris -f schema.sql
```

3. Примените любые миграции после схемы (при необходимости):
```bash
npm run migrate
```

## Развертывание в продакшен

### Контрольный список перед развертыванием
- [ ] Миграция была протестирована на копии продакшен-данных
- [ ] Доступна резервная копия продакшен-базы данных
- [ ] Миграция может быть откачена при необходимости
- [ ] Код приложения готов к новой схеме
- [ ] Миграция запланирована в период низкого трафика

### Процесс развертывания
1. Создайте резервную копию продакшен-базы данных
2. Разверните новый код приложения (включая файлы миграций)
3. Запустите миграции:
```bash
npm run migrate
```
4. Убедитесь, что изменения применены правильно
5. Протестируйте функциональность приложения
6. Мониторьте наличие каких-либо проблем

## Обработка сложных изменений схемы

### Добавление таблиц
```sql
-- Миграция для добавления новой таблицы
CREATE TABLE new_table (
    id uuid DEFAULT uuid_generate_v4() PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Добавить триггер для updated_at при необходимости
CREATE TRIGGER update_new_table_updated_at 
    BEFORE UPDATE ON new_table 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- Добавить комментарии
COMMENT ON TABLE new_table IS 'Описание новой таблицы';

-- Записать миграцию
INSERT INTO migrations (name) VALUES ('2025128160000_add_new_table.sql');
```

### Изменение существующих таблиц
```sql
-- Миграция для изменения существующей таблицы
-- Добавить новый столбец со значением по умолчанию
ALTER TABLE game_sessions ADD COLUMN new_feature_enabled BOOLEAN DEFAULT false;

-- Обновить существующие записи при необходимости
UPDATE game_sessions SET new_feature_enabled = true WHERE condition;

-- Сделать столбец NOT NULL при необходимости
ALTER TABLE game_sessions ALTER COLUMN new_feature_enabled SET NOT NULL;

-- Добавить ограничения при необходимости
ALTER TABLE game_sessions ADD CONSTRAINT chk_valid_value CHECK (column_name > 0);

-- Записать миграцию
INSERT INTO migrations (name) VALUES ('20251128160000_modify_game_sessions.sql');
```

### Удаление таблиц или столбцов
```sql
-- Миграция для удаления столбца (делайте это осторожно!)
-- Сначала убедитесь, что код приложения не ссылается на столбец
-- Затем удалите столбец
ALTER TABLE users DROP COLUMN deprecated_column;

-- Записать миграцию
INSERT INTO migrations (name) VALUES ('2025128160000_remove_deprecated_column.sql');
```

## Рекомендации

1. **Держите миграции небольшими и сфокусированными** - Каждая миграция должна решать одну задачу
2. **Тщательно тестируйте миграции** - Всегда тестируйте на копии продакшен-данных
3. **Рассмотрите миграцию данных** - Планируйте, как будут обрабатываться существующие данные
4. **Используйте транзакции** - Оберните связанные изменения в транзакции для обеспечения согласованности
5. **Документируйте изменения** - Добавляйте комментарии для объяснения цели изменений схемы
6. **Планируйте откаты** - Подумайте, как отменить изменения при необходимости
7. **Обновляйте код приложения** - Убедитесь, что ваш код приложения работает с новой схемой

## Устранение неполадок

### Миграция не удается
1. Проверьте сообщение об ошибке для получения конкретных деталей
2. Убедитесь, что миграция является действительным SQL
3. Убедитесь, что зависимости не отсутствуют
4. Проверьте, не конфликтует ли изменение с существующими данными
5. При необходимости исправьте проблему и попробуйте снова

### Необходимость отката
```bash
npm run rollback
```
Примечание: Текущий механизм отката просто удаляет запись миграции. Для сложных изменений вам может понадобиться реализовать конкретную логику отката.

### Миграция уже применена
Если вам нужно повторно применить миграцию, которая уже была записана:
1. Удалите запись миграции из таблицы миграций
2. Вручную отмените изменения базы данных
3. Повторно примените миграцию

## Резюме

Помните:
- Используйте файлы миграций для всех изменений схемы в развернутых средах
- `schema.sql` - это справочник для текущей схемы, а не для внесения изменений
- Всегда тестируйте миграции перед применением к продакшену
- Делайте резервные копии перед запуском миграций на важных данных
- Документируйте изменения схемы с помощью соответствующих комментариев